<!doctype html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KameraMark</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.23/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for KameraMark */
        body {
            font-family: 'Barlow', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            transition: background 0.3s, color 0.3s;
        }

        .navbar {
            background: var(--navbar-bg);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px var(--shadow-color);
            border-bottom: 1px solid var(--border-color);
        }

        .modal-box {
            background: var(--modal-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 25px -5px var(--shadow-color);
        }

        .btn-primary {
            background: var(--primary-color);
            border: none;
            color: white;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px var(--shadow-color);
        }

        .upload-label {
            background: var(--upload-bg);
            backdrop-filter: blur(10px);
            border: 2px dashed var(--primary-color);
            transition: all 0.3s ease;
            color: var(--primary-color);
        }

        .upload-label:hover {
            background: var(--upload-hover);
            transform: scale(1.05);
            box-shadow: 0 20px 25px -5px var(--shadow-color);
        }

        .select-theme {
            background-color: var(--select-bg);
            color: var(--select-text);
            border: 1px solid var(--border-color);
        }

        .select-theme:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color);
        }

        /* Light Mode Variables */
        :root {
            --select-bg: #ffffff;
            --select-text: #1f2937;
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --navbar-bg: rgba(255, 255, 255, 0.95);
            --modal-bg: rgba(255, 255, 255, 0.98);
            --border-color: rgba(0, 0, 0, 0.1);
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --upload-bg: rgba(255, 255, 255, 0.95);
            --upload-hover: rgba(79, 70, 229, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        /* Dark Mode Variables */
        .dark {
            --select-bg: #374151;
            --select-text: #f9fafb;
            --bg-color: #111827;
            --text-color: #f9fafb;
            --navbar-bg: rgba(17, 24, 39, 0.95);
            --modal-bg: rgba(17, 24, 39, 0.98);
            --border-color: rgba(255, 255, 255, 0.1);
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --upload-bg: rgba(31, 41, 55, 0.95);
            --upload-hover: rgba(99, 102, 241, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        /* Desktop centering */
        @media (min-width: 768px) {
            body {
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .dark body {
                background: linear-gradient(135deg, #1e3a8a 0%, #7e22ce 100%);
            }

            .app-container {
                width: 100%;
                max-width: 428px;
                height: 100vh;
                max-height: 926px;
                background: var(--bg-color);
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                border-radius: 20px;
                overflow: hidden;
                position: relative;
            }
        }

        /* Mobile full screen */
        @media (max-width: 767px) {
            .app-container {
                width: 100%;
                height: 100vh;
            }
        }

        /* Custom scrollbar */
        #preview::-webkit-scrollbar {
            width: 6px;
        }

        #preview::-webkit-scrollbar-track {
            background: transparent;
        }

        #preview::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .dark #preview::-webkit-scrollbar-thumb {
            background: #4b5563;
        }

        /* Smooth transitions */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }

        button,
        select,
        .upload-label {
            min-height: 44px;
            min-width: 44px;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Toast Notification -->
        <div id="toast"
            class="hidden fixed top-20 right-4 p-4 bg-base-100 text-base-content rounded-lg shadow-lg transition-transform transform translate-x-20 z-[9999] border border-base-300">
            <span id="toast-message"></span>
        </div>

        <!-- Navbar -->
        <div class="navbar bg-base-100 shadow-lg px-5 border-b border-base-300">
            <div class="flex-1 text-xl font-bold">KameraMark</div>
            <div class="flex-none">
                <label class="swap swap-rotate">
                    <input type="checkbox" id="theme-toggle" class="theme-controller" />
                    <i data-feather="sun" class="swap-off w-7 h-7"></i>
                    <i data-feather="moon" class="swap-on w-7 h-7"></i>
                </label>
            </div>
        </div>

        <!-- Main Content -->
        <main class="text-center flex justify-center items-center h-[calc(100svh-73px)]">
            <label
                class="upload-label w-[50vw] max-w-[200px] aspect-square flex justify-center items-center rounded-full text-7xl cursor-pointer bg-primary text-primary-content shadow-lg hover:shadow-xl"
                for="upload" id="upload-label">
                <i data-feather="plus"></i>
            </label>
            <input type="file" id="upload" class="hidden">
        </main>

        <!-- Settings Modal -->
        <div id="settings"
            class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-5 z-50 modal-overlay">
            <div class="bg-base-100 rounded-xl shadow-2xl w-full max-w-md p-5 border border-base-300">
                <h3 class="text-lg font-bold">Atur Watermark</h3>
                <div class="mt-4">
                    <form id="settingsForm" class="form-control">
                        <div class="*:w-full *:text-sm flex justify-between gap-3">
                            <label>
                                <p class="mb-2">Posisi Watermark</p>
                                <select class="select select-theme select-bordered w-full bg-base-100" name="posisi"
                                    id="posisi">
                                    <option value="center">Tengah</option>
                                    <option value="top-left">Kiri Atas</option>
                                    <option value="bottom-left">Kiri Bawah</option>
                                    <option value="top-right">Kanan Atas</option>
                                    <option value="bottom-right">Kanan Bawah</option>
                                </select>
                            </label>
                            <label>
                                <p class="mb-2">Jam</p>
                                <select class="select-theme select select-bordered w-full bg-base-100" name="jam"
                                    id="jam">
                                    <option disabled selected>Masuk/Pulang</option>
                                    <option>07:30</option>
                                    <option>11:30</option>
                                    <option>13:30</option>
                                    <option>17:30</option>
                                    <option>19:30</option>
                                    <option disabled>Lembur</option>
                                    <option>12:00</option>
                                    <option>18:00</option>
                                    <option>03:30</option>
                                </select>
                                <p id="jamError" class="text-red-500 text-sm mt-1 hidden">Pilih waktu yang valid!</p>
                            </label>
                        </div>
                        <label class="mt-4">
                            <p class="mb-2">Font Watermark</p>
                            <select class="select-theme select select-bordered w-full bg-base-100" name="font"
                                id="font">
                                <option value="Arial">Arial</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Courier New">Courier New</option>
                                <option value="Verdana">Verdana</option>
                                <option value="Trebuchet MS">Trebuchet MS</option>
                                <option value="Impact">Impact</option>
                                <option value="Comic Sans MS">Comic Sans MS</option>
                            </select>
                        </label>
                        <label class="mt-4">
                            <p class="mb-2">Sesuaikan Waktu (menit)</p>
                            <input type="range" id="bulatkanWaktu" name="bulatkanWaktu" min="0" max="10" step="1"
                                value="5" class="range range-primary" />
                            <div class="flex justify-between text-xs mt-2">
                                <span>-5</span><span>-4</span><span>-3</span><span>-2</span><span>-1</span><span>0</span><span>+1</span><span>+2</span><span>+3</span><span>+4</span><span>+5</span>
                            </div>
                        </label>
                        <div class="flex gap-2 mt-6">
                            <button type="button" class="btn btn-ghost flex-1" id="cancelSettings">Batal</button>
                            <button type="submit" class="btn btn-primary flex-1">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Preview Modal -->
        <div id="previewModal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-5 z-50 modal-overlay">
            <div class="bg-base-100 rounded-xl shadow-2xl w-full max-w-md p-5 border border-base-300">
                <h3 class="text-lg font-bold">Pratinjau</h3>
                <div class="modal-action flex flex-col gap-3">
                    <div id="preview" class="max-h-[60vh] overflow-auto">
                        <img src="" alt="" class="w-full rounded-md shadow-lg aspect-auto bg-base-100"
                            id="previewImage">
                    </div>
                    <div class="*:text-xl flex gap-3 items-center justify-between w-full">
                        <div class="flex gap-3">
                            <button
                                class="btn btn-ghost btn-circle text-primary hover:text-primary-focus cursor-pointer"
                                id="tangkapUlang" title="Tangkap Ulang">
                                <i data-feather="refresh-cw"></i>
                            </button>
                            <button
                                class="btn btn-ghost btn-circle text-primary hover:text-primary-focus cursor-pointer"
                                id="copyImage" title="Salin Gambar">
                                <i data-feather="copy"></i>
                            </button>
                            <button
                                class="btn btn-ghost btn-circle text-primary hover:text-primary-focus cursor-pointer"
                                id="share" title="Bagikan">
                                <i data-feather="share-2"></i>
                            </button>
                        </div>
                        <button class="btn btn-primary" id="simpan">
                            <i data-feather="download" class="mr-2"></i> Unduh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Elemen DOM
            const uploadInput = document.getElementById('upload');
            const uploadLabel = document.getElementById('upload-label');
            const settingsModal = document.getElementById('settings');
            const previewModal = document.getElementById('previewModal');
            const settingsForm = document.getElementById('settingsForm');
            const previewImage = document.getElementById('previewImage');
            const simpanButton = document.getElementById('simpan');
            const tangkapUlangButton = document.getElementById('tangkapUlang');
            const copyImageButton = document.getElementById('copyImage');
            const shareButton = document.getElementById('share');
            const cancelSettingsButton = document.getElementById('cancelSettings');
            const jamError = document.getElementById('jamError');
            const themeToggle = document.getElementById('theme-toggle');
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            let canvas;
            let originalImageData = null;

            // Daftar opsi penyesuaian waktu (menit)
            const waktuAdjustOptions = [-5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5];

            // Fungsi tampilkan toast
            function showToast(message, type = 'info') {
                toastMessage.textContent = message;
                toast.classList.remove('hidden', 'translate-x-20');
                toast.classList.add('translate-x-0');

                if (type === 'error') {
                    toast.classList.add('bg-error', 'text-error-content');
                } else if (type === 'success') {
                    toast.classList.add('bg-success', 'text-success-content');
                } else {
                    toast.classList.add('bg-base-100', 'text-base-content');
                }

                setTimeout(() => {
                    toast.classList.remove('translate-x-0');
                    toast.classList.add('translate-x-20');
                    setTimeout(() => {
                        toast.classList.add('hidden');
                        toast.classList.remove('bg-error', 'text-error-content', 'bg-success', 'text-success-content');
                    }, 300);
                }, 3000);
            }

            // Fungsi untuk menampilkan modal
            function showModal(modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            // Fungsi untuk menyembunyikan modal
            function hideModal(modal) {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
            }

            // Load preferensi dari localStorage
            function loadPreferences() {
                const savedPosisi = localStorage.getItem('watermarkPosisi') || 'center';
                const savedJam = localStorage.getItem('watermarkJam') || 'Masuk/Pulang';
                const savedFont = localStorage.getItem('watermarkFont') || 'Arial';
                const savedBulatkanWaktu = localStorage.getItem('watermarkBulatkanWaktu') || '5';

                document.getElementById('posisi').value = savedPosisi;
                document.getElementById('jam').value = savedJam;
                document.getElementById('font').value = savedFont;
                document.getElementById('bulatkanWaktu').value = savedBulatkanWaktu;
            }

            // Simpan preferensi ke localStorage
            function savePreferences(posisi, jam, font, bulatkanWaktu) {
                localStorage.setItem('watermarkPosisi', posisi);
                localStorage.setItem('watermarkJam', jam);
                localStorage.setItem('watermarkFont', font);
                localStorage.setItem('watermarkBulatkanWaktu', bulatkanWaktu);
            }

            // Kompresi gambar ke 1080p
            function compressImage(img, maxWidth = 1080, maxHeight = 1080, quality = 0.85) {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    let { width, height } = img;

                    if (width > height) {
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = Math.round((width * maxHeight) / height);
                            height = maxHeight;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;

                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob(resolve, 'image/jpeg', quality);
                });
            }

            // Muat preferensi
            loadPreferences();

            // Auto click upload on first load
            setTimeout(() => {
                uploadInput.click();
            }, 500);

            // Handle file upload
            uploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    showModal(settingsModal);
                } else {
                    showToast('Ups, file harus gambar (jpg, png, dll.)!', 'error');
                }
            });

            // Handle form submission
            settingsForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                const file = uploadInput.files[0];
                const posisi = document.getElementById('posisi').value;
                const jam = document.getElementById('jam').value;
                const bulatkanWaktu = document.getElementById('bulatkanWaktu').value;
                const font = document.getElementById('font').value;

                // Validasi waktu
                const jamSelect = document.getElementById('jam');
                const selectedOption = jamSelect.options[jamSelect.selectedIndex];
                if (selectedOption.disabled || jam === 'Masuk/Pulang') {
                    jamError.classList.remove('hidden');
                    return;
                } else {
                    jamError.classList.add('hidden');
                }

                // Simpan preferensi
                savePreferences(posisi, jam, font, bulatkanWaktu);

                // Format waktu
                const waktuFormatted = formatWaktu(jam, waktuAdjustOptions[bulatkanWaktu]);

                // Proses watermark
                showToast('Sedang memproses...', 'info');

                try {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const img = new Image();
                        img.src = e.target.result;

                        img.onload = async () => {
                            const compressedBlob = await compressImage(img);
                            const compressedImg = new Image();
                            compressedImg.src = URL.createObjectURL(compressedBlob);

                            compressedImg.onload = () => {
                                canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                canvas.width = compressedImg.width;
                                canvas.height = compressedImg.height;
                                ctx.drawImage(compressedImg, 0, 0);

                                const watermarkText = `${new Date().toLocaleDateString('en-GB')} ${waktuFormatted}`;

                                // Tambahkan watermark
                                addWatermark(canvas, ctx, watermarkText, posisi, font);

                                // Simpan data gambar asli untuk copy
                                originalImageData = canvas.toDataURL();

                                // Tampilkan preview
                                previewImage.src = originalImageData;
                                hideModal(settingsModal);
                                showModal(previewModal);
                                showToast('Gambar siap!', 'success');

                                URL.revokeObjectURL(compressedImg.src);
                            };
                        };
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('Error processing image:', error);
                    showToast('Gagal memproses gambar', 'error');
                }
            });

            // Format waktu (sesuaikan menit sesuai slider)
            function formatWaktu(jam, adjustMenit) {
                let [jamStr, menitStr] = jam.split(':');
                let jamNum = parseInt(jamStr, 10);
                let menitNum = parseInt(menitStr, 10) + adjustMenit;

                while (menitNum >= 60) {
                    menitNum -= 60;
                    jamNum += 1;
                }
                while (menitNum < 0) {
                    menitNum += 60;
                    jamNum -= 1;
                }
                jamNum = (jamNum + 24) % 24;

                return `${String(jamNum).padStart(2, '0')}:${String(menitNum).padStart(2, '0')}`;
            }

            // Tambahkan watermark ke gambar
            function addWatermark(canvas, ctx, text, posisi, font) {
                const fontSize = Math.floor(canvas.width * 0.03);
                const margin = Math.floor(canvas.width * 0.03);
                const opacity = 0.82;

                ctx.font = `bold ${fontSize}px ${font}`;
                let textWidth = ctx.measureText(text).width;
                while (textWidth > canvas.width * 0.8) {
                    ctx.font = `bold ${--fontSize}px ${font}`;
                    textWidth = ctx.measureText(text).width;
                }

                let x, y;
                switch (posisi) {
                    case 'center':
                        x = (canvas.width - textWidth) / 2;
                        y = canvas.height / 2;
                        break;
                    case 'top-left':
                        x = margin;
                        y = margin + fontSize;
                        break;
                    case 'bottom-left':
                        x = margin;
                        y = canvas.height - margin;
                        break;
                    case 'top-right':
                        x = canvas.width - textWidth - margin;
                        y = margin + fontSize;
                        break;
                    case 'bottom-right':
                        x = canvas.width - textWidth - margin;
                        y = canvas.height - margin;
                        break;
                }

                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 5;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;

                ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
                ctx.fillText(text, x, y);

                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
            }

            // Handle tombol Unduh di pratinjau
            simpanButton.addEventListener('click', () => {
                if (!canvas) {
                    showToast('Gambar belum siap!', 'error');
                    return;
                }
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');

                const fileName = `watermark-${year}${month}${day}-${hours}${minutes}${seconds}.jpg`;
                const link = document.createElement('a');
                link.download = fileName;
                link.href = canvas.toDataURL('image/jpeg', 0.85);
                link.click();

                showToast('Yeay, gambar udah tersimpan!', 'success');
            });

            // Handle tombol Salin Gambar
            copyImageButton.addEventListener('click', async () => {
                if (!originalImageData) {
                    showToast('Gambar belum siap!', 'error');
                    return;
                }

                try {
                    const response = await fetch(originalImageData);
                    const blob = await response.blob();

                    await navigator.clipboard.write([
                        new ClipboardItem({
                            [blob.type]: blob
                        })
                    ]);

                    showToast('Gambar berhasil disalin!', 'success');
                } catch (error) {
                    console.error('Error copying image:', error);
                    showToast('Gagal menyalin gambar', 'error');
                }
            });

            // Handle tombol Tangkap Ulang
            tangkapUlangButton.addEventListener('click', () => {
                hideModal(settingsModal);
                hideModal(previewModal);
                uploadInput.value = '';
                originalImageData = null;
            });

            // Handle tombol Batal di settings
            cancelSettingsButton.addEventListener('click', () => {
                hideModal(settingsModal);
                uploadInput.value = '';
                originalImageData = null;
            });

            // Handle tombol Share
            shareButton.addEventListener('click', async () => {
                if (!canvas) {
                    showToast('Gambar belum siap!', 'error');
                    return;
                }

                try {
                    canvas.toBlob(async (blob) => {
                        const file = new File([blob], 'watermarked-image.jpg', { type: 'image/jpeg' });

                        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                            try {
                                await navigator.share({
                                    files: [file],
                                    title: 'Gambar dengan Watermark',
                                    text: 'Lihat gambar dengan watermark dari KameraMark!',
                                });
                                showToast('Gambar berhasil dibagikan!', 'success');
                            } catch (shareError) {
                                console.error('Error sharing:', shareError);
                                fallbackShare(blob);
                            }
                        } else {
                            fallbackShare(blob);
                        }
                    }, 'image/jpeg', 0.85);
                } catch (error) {
                    console.error('Error in share:', error);
                    showToast('Gagal membagikan gambar', 'error');
                }
            });

            // Fallback share function
            function fallbackShare(blob) {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'watermarked-image.jpg';
                link.click();
                URL.revokeObjectURL(link.href);
                showToast('Gambar berhasil diunduh!', 'success');
            }

            // Handle toggle dark mode
            themeToggle.addEventListener('change', (event) => {
                const isDarkMode = event.target.checked;
                document.documentElement.classList.toggle('dark', isDarkMode);
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                feather.replace();
            });

            // Set initial theme
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initialTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
            document.documentElement.classList.toggle('dark', initialTheme === 'dark');
            themeToggle.checked = initialTheme === 'dark';

            // Initialize feather icons
            feather.replace();
        });
    </script>
</body>

</html>
